name: Build FFmpeg Android
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [aarch64, x86, riscv64, armv7, x86_64]
        ffmpeg_static: [false, true]
      fail-fast: false
    env:
      BUILD_DIR: ${{ github.workspace }}/build
      LATEST_GIT: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install system dependencies and build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential jq cmake ninja-build make autoconf automake libtool pkg-config texinfo gettext gperf bison flex git xz-utils unzip diffutils file findutils coreutils binutils python3 python3-pip python3-venv pipx subversion libtool-bin nasm yasm

      - name: Install pipx and meson
        run: |
          python3 -m pip install --user pipx
          python3 -m pipx ensurepath
          export PATH="$HOME/.local/bin:$PATH"
          pipx install meson
          meson --version

      - name: Install Android NDK (r29 beta4)
        run: |
          cd $HOME
          curl -LO https://dl.google.com/android/repository/android-ndk-r29-beta4-linux.zip
          unzip android-ndk-r29-beta4-linux.zip
          mv android-ndk-r29-beta4 $HOME/android-ndk-r29

          echo "ANDROID_NDK_ROOT=$HOME/android-ndk-r29" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$HOME/android-ndk-r29" >> $GITHUB_ENV

          TOOLCHAIN=$HOME/android-ndk-r29/toolchains/llvm/prebuilt/linux-x86_64/bin
          ln -sf $TOOLCHAIN/aarch64-linux-android29-clang    $TOOLCHAIN/aarch64-linux-android-gcc
          ln -sf $TOOLCHAIN/armv7a-linux-androideabi29-clang $TOOLCHAIN/arm-linux-androideabi-gcc
          ln -sf $TOOLCHAIN/x86_64-linux-android29-clang     $TOOLCHAIN/x86_64-linux-android-gcc
          ln -sf $TOOLCHAIN/i686-linux-android29-clang       $TOOLCHAIN/i686-linux-android-gcc

          echo "$TOOLCHAIN" >> $GITHUB_PATH

      
      - name: Set ARCH and FFMPEG_STATIC
        run: |
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "BUILD_TARGET=android" >> $GITHUB_ENV
          if [ "${{ matrix.ffmpeg_static }}" == "true" ]; then
            echo "FFMPEG_STATIC=1" >> $GITHUB_ENV
          fi

      - name: Build FFmpeg
        run: |
          rm -f git-sources.lock
          bash ${{ github.workspace }}/build.sh
        env:
          ARCH: ${{ matrix.arch }}
          LATEST_GIT: 1

      - name: Upload module files (zip and deb)
        uses: actions/upload-artifact@v4
        with:
          name: module-files-${{ matrix.arch }}-${{ matrix.ffmpeg_static }}
          path: |
            ${{ github.workspace }}/module/*.zip
            ${{ github.workspace }}/module/*.deb

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract FFmpeg commit
        id: ffmpeg
        run: |
          ZIP_FILE=$(find artifacts -name "*-Static-android-arm64-v8a.zip" | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "Error: Could not find aarch64 Static build zip"
            exit 1
          fi
          FFMPEG_COMMIT=$(unzip -p "$ZIP_FILE" ffmpeg_commit.txt)
          echo "FFMPEG_COMMIT=$FFMPEG_COMMIT" >> $GITHUB_ENV

      - name: Show collected files
        run: ls -R artifacts

      - name: Set build date
        run: echo "BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_ENV  

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "FFmpeg Android Build ${{ github.run_number }}"
          body: |
            ## FFmpeg Android Builds

            - **Dynamic builds** include hardware acceleration support through MediaCodec and OpenCL (if the device supports it).  
            - **Static builds** are completely static and may not support hardware acceleration at all.  
            - **Build ZIPs** can be flashed through Magisk as a Magisk module.  
            - **Build DEBs** (only available for Dynamic builds) can be installed on Termux using `dpkg -i --force-overwrite <path-to-package>`

            ### Available Architectures
            - `arm64-v8a`
            - `armeabi-v7a`
            - `x86_64`
            - `x86`
            - `riscv64`

            ### Installation Notes
            - **For Magisk modules:** Flash the `.zip` files through Magisk Manager
            - **For Termux:** Static builds are not available for Termux. Use the `.deb` packages from Dynamic builds with:
              ```bash
              dpkg -i --force-overwrite <path-to-package>
              ```

            **To find your device architecture:** run `getprop ro.product.cpu.abi` in a terminal  

            **Build Date:** ${{ env.BUILD_DATE }}
            **Repo Commit:** https://github.com/FFmpeg/FFmpeg/commit/${{ env.FFMPEG_COMMIT }}
          files: |
            artifacts/**/*.zip
            artifacts/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python dependencies
        run: |
          python3 -m pip install requests

      - name: Upload to Telegram Channel
        if: success()
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json
          import time
          from pathlib import Path

          TELEGRAM_TOKEN = os.environ['TELEGRAM_TOKEN']
          CHANNEL_ID = "@ffmpegandroid"
          MAX_FILE_SIZE = 50 * 1024 * 1024
          
          def send_message(text):
              url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
              data = {
                  'chat_id': CHANNEL_ID,
                  'text': text,
                  'parse_mode': 'Markdown'
              }
              response = requests.post(url, data=data)
              return response.json()

          def send_document(file_path, caption):
              url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendDocument"
              
              with open(file_path, 'rb') as file:
                  files = {'document': file}
                  data = {
                      'chat_id': CHANNEL_ID,
                      'caption': caption,
                      'parse_mode': 'Markdown'
                  }
                  response = requests.post(url, files=files, data=data)
              return response.json()

          def get_file_size(file_path):
              return os.path.getsize(file_path)

          def is_static_build(filename):
              return 'static' in filename.lower()
          announcement = f"""üöÄ **FFmpeg Android Build {os.environ['GITHUB_RUN_NUMBER']}**

          üìÖ **Build Date:** {os.environ['BUILD_DATE']}
          üîó **Repo Commit:** [View Commit](https://github.com/FFmpeg/FFmpeg/commit/{os.environ['FFMPEG_COMMIT']})
          üì¶ **Release:** [Download](https://github.com/{os.environ['GITHUB_REPOSITORY']}/releases/tag/build-{os.environ['GITHUB_RUN_NUMBER']})

          **Available Builds:**
          ‚Ä¢ Dynamic builds (with hardware acceleration)
          ‚Ä¢ Static builds (completely static)
          ‚Ä¢ All major Android architectures supported

          **Installation:**
          ‚Ä¢ **Magisk:** Flash .zip files
          ‚Ä¢ **Termux:** Use .deb files with `dpkg -i --force-overwrite <package>`

          Files are being uploaded below... üìÇ
          
          ‚ö†Ô∏è **Note:** Static builds larger than 50MB are available only via GitHub releases due to Telegram file size limits."""

          print("Sending announcement message...")
          result = send_message(announcement)
          if result.get('ok'):
              print("‚úÖ Announcement sent successfully")
          else:
              print(f"‚ùå Failed to send announcement: {result}")

          time.sleep(2)

          artifacts_path = Path('artifacts')
          uploaded_count = 0
          skipped_count = 0
          
          for file_path in artifacts_path.rglob('*'):
              if file_path.is_file() and file_path.suffix in ['.zip', '.deb']:
                  filename = file_path.name
                  file_size = get_file_size(file_path)
                  
                  if is_static_build(filename) and file_size > MAX_FILE_SIZE:
                      print(f"‚è≠Ô∏è  Skipping {filename} (Static build, {file_size / (1024*1024):.1f}MB > 50MB limit)")
                      skipped_count += 1
                      continue
                  
                  if file_size > MAX_FILE_SIZE:
                      print(f"‚ö†Ô∏è  Warning: {filename} is {file_size / (1024*1024):.1f}MB (over Telegram limit)")
                      skipped_count += 1
                      continue
                  
                  print(f"üì§ Uploading {filename} ({file_size / (1024*1024):.1f}MB)...")
                  
                  caption = f"üì¶ {filename}\nüîó [Commit](https://github.com/FFmpeg/FFmpeg/commit/{os.environ['FFMPEG_COMMIT']})"
                  
                  try:
                      result = send_document(file_path, caption)
                      if result.get('ok'):
                          print(f"‚úÖ Successfully uploaded: {filename}")
                          uploaded_count += 1
                      else:
                          print(f"‚ùå Failed to upload {filename}: {result.get('description', 'Unknown error')}")
                  except Exception as e:
                      print(f"‚ùå Exception uploading {filename}: {str(e)}")
                  
                  time.sleep(1)

          summary = f"""üìä **Upload Summary**
          ‚úÖ Successfully uploaded: {uploaded_count} files
          ‚è≠Ô∏è  Skipped (size limit): {skipped_count} files
          
          All files are available at: [GitHub Release](https://github.com/{os.environ['GITHUB_REPOSITORY']}/releases/tag/build-{os.environ['GITHUB_RUN_NUMBER']})"""
          
          send_message(summary)
          print(f"‚úÖ Upload completed! {uploaded_count} files uploaded, {skipped_count} skipped")
          EOF
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          BUILD_DATE: ${{ env.BUILD_DATE }}
          FFMPEG_COMMIT: ${{ env.FFMPEG_COMMIT }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  update-jsons:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract changelog.md
        run: |
          ZIP_FILE=$(find artifacts -name "*-Static-android-arm64-v8a.zip" | head -n 1)
          unzip -p "$ZIP_FILE" changelog.md > changelog.md

      - name: Update all JSON files
        run: |
          ARCHS="aarch64 x86 riscv64 armv7 x86_64"
          TYPES="Dynamic Static"

          cd artifacts

          for ARCH in $ARCHS; do
            for TYPE in $TYPES; do
              echo "Processing $ARCH - $TYPE"

              ZIP_FILE=$(find . -name "*.zip" | grep -i "$ARCH" | grep -i "$TYPE" | head -1)

              if [ -z "$ZIP_FILE" ]; then
                echo "Warning: No zip file found for $ARCH-$TYPE"
                continue
              fi

              echo "Found zip file: $ZIP_FILE"

              VERSION=$(unzip -p "$ZIP_FILE" module.prop | grep "^version=" | cut -d'=' -f2-)
              VERSION_CODE=$(unzip -p "$ZIP_FILE" module.prop | grep "^versionCode=" | cut -d'=' -f2-)

              JSON_DIR="${{ github.workspace }}/updateJsons/$ARCH/$TYPE"
              mkdir -p "$JSON_DIR"

              ZIP_FILENAME=$(basename "$ZIP_FILE")
              RELEASE_TAG="build-${{ github.run_number }}"
              ZIP_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${ZIP_FILENAME}"

              jq -n \
                --argjson versionCode "$VERSION_CODE" \
                --arg version "$VERSION" \
                --arg zipUrl "$ZIP_URL" \
                --arg changelog "https://raw.githubusercontent.com/${{ github.repository }}/main/changelog.md" \
                '{
                  versionCode: $versionCode,
                  version: $version,
                  zipUrl: $zipUrl,
                  changelog: $changelog
                }' > "$JSON_DIR/updateJson"

              echo "Updated $JSON_DIR/updateJson"
            done
          done

      - name: Commit and push all JSON changes
        run: |
          git add changelog.md
          git add updateJsons/*/*/updateJson
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update JSON files for build ${{ github.run_number }}"
            git push origin main
          fi
